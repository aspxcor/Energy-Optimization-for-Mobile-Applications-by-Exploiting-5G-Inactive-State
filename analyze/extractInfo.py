import numpy as np
import os
import re
import pandas as pd
import xlwt

# Usage: output an excel for STRACE: hour, minute, second, millisecond, command,
# paras, return, duration

def transpose(matrix):
    new_matrix = []
    for i in range(len(matrix[0])):
        matrix1 = []
        for j in range(len(matrix)):
            matrix1.append(matrix[j][i])
        new_matrix.append(matrix1)
    return new_matrix

features_final_path = 'E:\\Emnets\\5G\\powerMonitor\\ZTE\data\\'
feature_dirs = []
trace_nums = []
for file in os.listdir(features_final_path):
    print(file)
    file_path = os.path.join(features_final_path,file)
    if os.path.isdir(file_path) and ("trace" in file):
        feature_dirs.append(file_path)
        temp_pos = file.rindex('e')
        trace_nums.append(file[temp_pos+1:])
print(trace_nums)

for trace_num in trace_nums:
    # trace_num = '8'
    store_path = 'E:\\Emnets\\5G\\powerMonitor\\ZTE\data\\trace'+ trace_num+ '\\'
    file_path = store_path+'strace_'+ trace_num +'.txt'

    raw_info = []

    with open(file_path, "r") as f:
        for line in f.readlines():
            line = line.strip('\n')  #去掉列表中每一个元素的换行符
            raw_info.append(line)

    print(np.shape(raw_info))
    # print(raw_info[0])

    info_leng = len(raw_info)-1
    hour_list = np.zeros(info_leng)
    minute_list = np.zeros(info_leng)
    second_list = np.zeros(info_leng)
    millisecond_list = np.zeros(info_leng)
    command_list = []
    paras_list = []
    ret_list = []
    duration_list = np.zeros(info_leng)

    for index in range(info_leng):
        [millisecond, remain3] = raw_info[index].split(" ", 1)
        # hour_list[index] = int(hour)+8
        # minute_list[index] = minute
        # # print(remain)
        #
        # [second, remain2] = remain.split(".",1)
        # second_list[index] = second
        # # print(remain2)
        #
        # [millisecond, remain3] = remain2.split(" ", 1)
        millisecond_list[index] = millisecond
        print(millisecond)
        # print(remain3)

        [command, remain4] = remain3.split("(", 1)
        command_list.append(command)
        print(remain4)

        if('Segmentation fault) @ 0 (0) ---' in remain4):
            paras_list.append('Segmentation fault')
            ret_list.append('0')
            duration_list[index] = 0
            continue

        temp_end = remain4.rindex('=')
        # print("temp_end:",temp_end)
        remain4_temp = remain4[0:temp_end]
        temp_right = remain4_temp.rindex(')')
        paras = remain4_temp[0:temp_right]
        # print("paras:",paras)
        remain5 = remain4[temp_end+1:]
        paras_list.append(paras)
        # print("remain5:",remain5)

        # print(re.split(r"[ ]+", remain5))
        # input()
        temp_right_2 = remain5.rindex('<')
        remain6 = remain5[temp_right_2:]
        # print("remain6:",remain6)
        ret = remain5.split(" ")[1]
        ret_list.append(ret)
        # print("ret:",ret)

        # p1 = re.compile(r'<.*?>', re.S)
        # duration = re.findall(p1, remain6)
        duration = re.sub('<|>','',remain6)
        duration_list[index] = duration
        # print(duration_list)
        # input()



    list = [millisecond_list, command_list, paras_list, ret_list, duration_list]
    list = transpose(list)
    print(np.shape(list))
    dataframe = pd.DataFrame(list)
    print(dataframe)
    # if not os.path.exists(store_path+'trace_'+trace_num+'.csv'):
    #     dataframe.to_csv(store_path+'trace_'+trace_num+'.csv')
    #     print("save file:",store_path+'trace_'+trace_num+'.csv')
    dataframe.to_csv(store_path + 'trace_' + trace_num + '.csv')
