import datetime

import numpy as np
import os
import re
import pandas as pd
import xlwt

# Usage: output an excel for STRACE: hour, minute, second, millisecond, command,
# paras, return, duration

app = '/qqmusic'

app_uid = 'a166'

def transpose(matrix):
    new_matrix = []
    for i in range(len(matrix[0])):
        matrix1 = []
        for j in range(len(matrix)):
            matrix1.append(matrix[j][i])
        new_matrix.append(matrix1)
    return new_matrix

features_final_path = "E:/Emnets/5G/powerMonitor/ZTE/data"+app+"/"
feature_dirs = []
trace_nums = []
for file in os.listdir(features_final_path):
    # print(file)
    file_path = os.path.join(features_final_path,file)
    if os.path.isdir(file_path) and ("trace" in file):
        feature_dirs.append(file_path)
        temp_pos = file.rindex('e')
        trace_nums.append(file[temp_pos+1:])
print(trace_nums)

for trace_num in trace_nums:
    # trace_num = '100'
    store_path = "E:/Emnets/5G/powerMonitor/ZTE/data"+app+"/trace" + str(trace_num) + "/"
    file_path = store_path+'memory_full_'+ trace_num +'.log'

    raw_info = []

    with open(file_path, "r") as f:
        for line in f.readlines():
            line = line.strip('\n')  # 去掉列表中每一个元素的换行符
            raw_info.append(line)

    info_leng = len(raw_info)
    print(info_leng)
    # hour_list = np.zeros(int(info_leng/2))
    # minute_list = np.zeros(int(info_leng/2))
    # second_list = np.zeros(int(info_leng/2))
    # millisecond_list = np.zeros(int(info_leng/2))
    useful_info = []
    list_all = []
    for index in range(info_leng):
        if "TOTAL  " in raw_info[index] or "time:161" in raw_info[index]:
            useful_info.append(raw_info[index])
    dataframe = pd.DataFrame(useful_info)
    # if not os.path.exists(store_path + 'battery_'+trace_num+'.csv'):
    #     dataframe.to_csv(store_path + 'battery_'+trace_num+'.csv')
    dataframe.to_csv(store_path + 'memory_mid_' + trace_num + '.csv')
    # input()
    useful_info_length = len(useful_info)
    temp_info = []
    for index in range(useful_info_length):
        # temp_info:
        # time, pss_total, pri_dirty, pri_clean, swap_dirty, heap_size, heap_alloc, heap_free
        if "TOTAL  " in useful_info[index]:
            str_list = useful_info[index].split()
            print(str_list)
            temp_info.append(str_list[1])
            temp_info.append(str_list[2])
            temp_info.append(str_list[3])
            temp_info.append(str_list[4])
            temp_info.append(str_list[5])
            temp_info.append(str_list[6])
            temp_info.append(str_list[7])
        if "time:" in useful_info[index]:
            temp_pos = useful_info[index].index(":")
            temp_time = useful_info[index][temp_pos+1:]
            temp_info.insert(0,temp_time)
            # print(temp_info)
            # input()
            list_all.append(temp_info)
            temp_info = []
        # print(temp_info)
        # input()
    print(np.shape(list_all))
    # input()
    dataframe = pd.DataFrame(list_all)
    # if not os.path.exists(store_path + 'port_PID'+ port_num +'_'+trace_num+'.csv'):
    #     dataframe.to_csv(store_path + 'port_PID'+ port_num +'_'+trace_num+'.csv')
    dataframe.to_csv(store_path + 'memory_' + trace_num + '.csv')
    # input()
