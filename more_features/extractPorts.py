from scapy.all import *
import json
import numpy as np
import datetime
import pandas as pd

app = '/qqmusic'

port_num = ''

features_final_path = "E:/Emnets/5G/powerMonitor/ZTE/data"+app+"/"
feature_dirs = []
trace_nums = []
for file in os.listdir(features_final_path):
    print(file)
    file_path = os.path.join(features_final_path,file)
    if os.path.isdir(file_path) and ("trace" in file):
        feature_dirs.append(file_path)
        temp_pos = file.rindex('e')
        trace_nums.append(file[temp_pos+1:])
print(trace_nums)

for trace_num in trace_nums:
    # trace_num = '100'
    # if (101>=int(trace_num)>=23):
    #     port_num = '18708'
    # elif (int(trace_num)>=102):
    #     port_num = '17569'
    # else:
    #     port_num = '24239'
    print(trace_num)
    store_path = "E:/Emnets/5G/powerMonitor/ZTE/data"+app+"/trace" + str(trace_num) + "/"
    file_path = store_path+'PID'+ port_num +'_port_'+trace_num+'.log'

    raw_info = []

    with open(file_path, "r") as f:
        for line in f.readlines():
            line = line.strip('\n')  #去掉列表中每一个元素的换行符
            raw_info.append(line)

    info_leng = len(raw_info)
    # hour_list = np.zeros(int(info_leng/2))
    # minute_list = np.zeros(int(info_leng/2))
    # second_list = np.zeros(int(info_leng/2))
    # millisecond_list = np.zeros(int(info_leng/2))
    list_all = []

    for index in range(info_leng):
        mh = raw_info[index].index(":")
        name = raw_info[index][0:mh]
        content = raw_info[index][(mh+1):]
        # print(index)
        # print(raw_info[index])
        # print(content)
        if name == "time":
            temp_time = []
            if '.' not in content:
                continue
            [second, millisecond] = content.split(".")
            temp_date = datetime.datetime.fromtimestamp(int(second))
            # print(temp_date)
            # hour_list[int(index/2)] = temp_date.hour
            # minute_list[int(index/2)] = temp_date.minute
            # second_list[int(index/2)] = temp_date.second
            # millisecond_list[int(index/2)] = millisecond
            temp_time.append(content)
            temp_time.append(temp_date.hour)
            temp_time.append(temp_date.minute)
            temp_time.append(temp_date.second)
            temp_time.append(millisecond)
        elif name == "port":
            addr_list = content.split(" ")
            # print(addr_list)
            addr_len = len(addr_list)
            for i in range(addr_len):
                if ':' not in addr_list[i]:
                    temp_time.append("")
                    continue
                r_mh = addr_list[i].rindex(":")
                temp_addr = addr_list[i][0:r_mh]
                temp_port = addr_list[i][(r_mh+1):]
                # temp_time.append(temp_addr)
                temp_time.append(temp_port)
            list_all.append(temp_time)
    print(np.shape(list_all))
    dataframe = pd.DataFrame(list_all)
    # if not os.path.exists(store_path + 'port_PID'+ port_num +'_'+trace_num+'.csv'):
    #     dataframe.to_csv(store_path + 'port_PID'+ port_num +'_'+trace_num+'.csv')
    dataframe.to_csv(store_path + 'port_PID_' + trace_num + '.csv')