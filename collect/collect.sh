#!/bin/sh

# usage: raw smartphone data collection
# 1. use 'ifconfig' to get the interface name
# 2. use 'ps -A' to get the app PID
# 3. change the app name in line 32 and line 33

if [ $# -lt 5 ];
then
    echo "Error: the command should be: sudo ./collect.sh network_interface(ifconfig) app_PID(ps -A) trace_num duration name."
    exit
fi

trap killfunc SIGINT

killfunc(){
	echo stopping collection...
	dumpsys battery reset
	end=$(date "+%s")
	echo "collection time: $((end-start))"
	echo "$((end-start))" >> /data/collection/$5/duration.txt
	kill 0
}

echo "start collection in 3 seconds..."
mkdir /data/collection/$5
mkdir /data/collection/$5/trace$3
dumpsys battery unplug
dumpsys batterystats --reset
logcat -c
sleep 3
echo "------------------start-------------------"
while true; do echo -e "time:\c" >> /data/collection/$5/trace$3/PID$2_port_$3.log; echo "scale=9;$(date +%s%N) / 1000000000" |bc >> /data/collection/$5/trace$3/PID$2_port_$3.log; port2=$(netstat -utpn |grep com.ss.android.ugc.aweme|awk '{printf $4"\n"}'); echo port:$port2 >> /data/collection/$5/trace$3/PID$2_port_$3.log; sleep 0.002; done &
while true; do dumpsys batterystats com.ss.android.ugc.aweme >> /data/collection/$5/trace$3/battery_full_$3.log; echo -e "time:\c" >> /data/collection/$5/trace$3/battery_full_$3.log; echo "scale=9;$(date +%s%N) / 1000000000" |bc >> /data/collection/$5/trace$3/battery_full_$3.log; sleep 0.002; done &
while true; do dumpsys meminfo $2 >> /data/collection/$5/trace$3/memory_full_$3.log; echo -e "time:\c" >> /data/collection/$5/trace$3/memory_full_$3.log; echo "scale=9;$(date +%s%N) / 1000000000" |bc >> /data/collection/$5/trace$3/memory_full_$3.log; sleep 0.002; done &
while true; do top -p $2 -b -n 1 >> /data/collection/$5/trace$3/cpu_full_$3.log; echo -e "time:\c" >> /data/collection/$5/trace$3/cpu_full_$3.log; echo "scale=9;$(date +%s%N) / 1000000000" |bc >> /data/collection/$5/trace$3/cpu_full_$3.log; sleep 0.002; done &
while true; do cat /sys/class/power_supply/battery/current_now >> /data/collection/$5/trace$3/energy_$3.log; echo -e "time:\c" >> /data/collection/$5/trace$3/energy_$3.log; echo "scale=9;$(date +%s%N) / 1000000000" |bc >> /data/collection/$5/trace$3/energy_$3.log; sleep 0.002; done &
nohup logcat --pid=$2 -f /data/collection/$5/trace$3/logcat_$3.log &
nohup /data/collection/strace -T -ttt -e trace=all -p $2 -o /data/collection/$5/trace$3/strace_$3.txt &
nohup tcpdump -i $1 -s 0 -w /data/collection/$5/trace$3/capture_$3.pcap &

start=$(date "+%s")

sleep $4
echo "------------------end-------------------"
kill -2 $!
killfunc

wait
